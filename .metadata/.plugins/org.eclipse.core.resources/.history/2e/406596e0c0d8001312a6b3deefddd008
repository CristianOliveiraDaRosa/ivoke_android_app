package com.app.ivoke.libraries;

import com.app.ivoke.Common;
import com.app.ivoke.helpers.DebugHelper;
import com.app.ivoke.helpers.SettingsHelper;

import android.content.Context;
import android.content.SharedPreferences;
import android.util.Log;

public class GCMManager {
	DebugHelper dbg = new DebugHelper("GCMManager");
	
	public static final String PREF_REGISTRATION_ID = "com.app.ivoke.registration_id";
	
	public String getRegistrationId(Context context) {
		dbg.method("getRegistrationId");
	    final SharedPreferences prefs = getGCMPreferences(context);
	    String registrationId = prefs.getString(PREF_REGISTRATION_ID, "");
	    if (registrationId.isEmpty()) {
	    	dbg.log("Not registration");
	        return "";
	    }
	    // Check if app was updated; if so, it must clear the registration ID
	    // since the existing regID is not guaranteed to work with the new
	    // app version.
	    int registeredVersion = prefs.getInt(PROPERTY_APP_VERSION, Integer.MIN_VALUE);
	    int currentVersion = getAppVersion(context);
	    if (registeredVersion != currentVersion) {
	        Log.i(TAG, "App version changed.");
	        return "";
	    }
	    return registrationId;
	}
	
	private SharedPreferences getGCMPreferences(Context context) {
	    return SettingsHelper.getSharedPreference(context);
	}
}
