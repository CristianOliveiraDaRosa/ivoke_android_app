package com.app.ivoke.controllers.main;

import java.util.List;
import java.util.Timer;
import java.util.TimerTask;

import com.app.ivoke.R;

import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ListView;

import com.app.ivoke.controllers.main.MainActivity.MuralCallback;
import com.app.ivoke.helpers.DebugHelper;
import com.app.ivoke.helpers.MessageHelper;
import com.app.ivoke.helpers.SettingsHelper;
import com.app.ivoke.models.MuralModel;
import com.app.ivoke.objects.*;
import com.app.ivoke.objects.adapters.MuralAdapter;
import com.app.ivoke.objects.interfaces.IAsyncCallBack;

public class MuralFragment extends Fragment {
	  
	  MainActivity          mainAct;
	  MuralAdapter          adapter;
	  RefreshMuralCallback  refreshCallback;
	  DebugHelper dbg = new DebugHelper("MuralFragment");
	 
	  Timer     muralRefreshTimer;
	  TimerTask muralRefreshTask = new TimerTask() {
			@Override
			public void run() {
				try {
					mainAct
					.muralModel.asyncGetNearbyPosts( mainAct.user.getLocalization() 
		    	 			                       , SettingsHelper.getMuralPostDistance(mainAct)
		    	 			                       , refreshCallback);
		    	} catch (Exception e) {
					MessageHelper.errorAlert(mainAct)
								 .setMessage(R.string.msg_error_ws_server_not_responding)
								 .showDialog();
				}
			}
		  };
	  
	  List<MuralPost> postagens;
	  
	  ListView listView;
	  
	  @Override
	  public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
		dbg.method("onCreateView");
	    View view = inflater.inflate(R.layout.main_mural_fragment, container, false);
	    
	    mainAct = (MainActivity) getActivity();
	    
	    listView = (ListView) view.findViewById(R.id.main_mural_posts_list);
	    
	    dbg.var("postagens", postagens);
	    
	    adapter = new MuralAdapter(view.getContext(), postagens);
	    dbg.var("adapter", adapter);
	    
	    listView.setAdapter(adapter);
	    
	    return view;
	  }
	  
	  public void setPosts(List<MuralPost> pPostagens)
	  {
		  postagens = pPostagens;
		  refreshListView();
	  }
	  
	  public void refreshStop() throws InterruptedException
	  {
		  if(muralRefreshTimer!=null)
		  {  
			  muralRefreshTask.cancel();
			  muralRefreshTimer.cancel();
			  muralRefreshTimer.purge();
		  }
	  }
	  
	  public void refreshStart()
	  {
		  muralRefreshTimer = new Timer();
		  muralRefreshTimer.schedule(muralRefreshTask, 10);
	  }
	  
	  public void refreshListView()
	  {
		 if(listView!=null)
			 if(adapter!=null)
			  {  
				  adapter.setItens(postagens);
			      adapter.notifyDataSetChanged();
			  }
	  }
	  
	  public class RefreshMuralCallback implements IAsyncCallBack
	    {	
	    	@Override
			public void onCompleteTask(Object pResult) {
	    		dbg._class(this).method("onCompleteTask").par("pResult", pResult);
	    		
	    		try {
	    			List<MuralPost> posts;
	    			posts = mainAct.muralModel.getListPostsFromJSon(pResult.toString());
					setPosts(posts);
		    	} catch (Exception e) {
					MessageHelper.unexpectedException(mainAct, e);
				}
	    		
			}

			@Override
			public void onPreExecute() {}

			@Override
			public void onProgress(int pPercent, Object pObject) {}

	    }
}
